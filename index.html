import React, { useState, useEffect, useRef } from 'react';
import { Plus, Trash2, Calendar, Heart, Clock, Sparkles, X, ChevronRight } from 'lucide-react';

/**
 * Flux Moments - A High-End Holiday Countdown App
 * Designed for visual impact and emotional connection.
 */

// --- ç²’å­ç³»ç»Ÿ (Canvas) ---
// ç”¨äºç‚¹å‡»æ—¶çš„åº†ç¥ç‰¹æ•ˆ
const ParticleCanvas = ({ activeColor }) => {
  const canvasRef = useRef(null);
  const particles = useRef([]);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    let animationFrameId;

    const resizeCanvas = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const createParticle = (x, y) => {
      const particleCount = 30;
      for (let i = 0; i < particleCount; i++) {
        particles.current.push({
          x,
          y,
          vx: (Math.random() - 0.5) * 10,
          vy: (Math.random() - 0.5) * 10,
          life: 1.0,
          color: activeColor || '#fff',
          size: Math.random() * 4 + 1
        });
      }
    };

    const render = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      particles.current.forEach((p, index) => {
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.02;
        p.size *= 0.95;

        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();

        if (p.life <= 0) {
          particles.current.splice(index, 1);
        }
      });

      animationFrameId = requestAnimationFrame(render);
    };

    // æš´éœ²ç‚¹å‡»ç”Ÿæˆç²’å­çš„æ–¹æ³•ç»™å…¨å±€äº‹ä»¶
    const handleGlobalClick = (e) => {
       // åªæœ‰ç‚¹å‡»ä¸»è¦åŒºåŸŸæ‰è§¦å‘ï¼Œé¿å…è¯¯è§¦
       if(e.target.closest('.interactive-zone')) {
         createParticle(e.clientX, e.clientY);
       }
    };

    window.addEventListener('click', handleGlobalClick);
    render();

    return () => {
      window.removeEventListener('resize', resizeCanvas);
      window.removeEventListener('click', handleGlobalClick);
      cancelAnimationFrame(animationFrameId);
    };
  }, [activeColor]);

  return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-50" />;
};

// --- å·¥å…·å‡½æ•° ---
const calculateTimeLeft = (targetDate) => {
  const difference = +new Date(targetDate) - +new Date();
  let timeLeft = {};

  if (difference > 0) {
    timeLeft = {
      days: Math.floor(difference / (1000 * 60 * 60 * 24)),
      hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
      minutes: Math.floor((difference / 1000 / 60) % 60),
      seconds: Math.floor((difference / 1000) % 60),
    };
  } else {
    timeLeft = { days: 0, hours: 0, minutes: 0, seconds: 0 };
  }
  return timeLeft;
};

// --- ä¸»ç»„ä»¶ ---
export default function FluxMoments() {
  // é»˜è®¤èŠ‚æ—¥æ•°æ®
  const initialEvents = [
    { id: 1, title: "æ–°å¹´", date: "2026-01-01", theme: "from-blue-500 to-purple-600", icon: "ğŸ‰", desc: "å…¨æ–°ç¯‡ç« çš„å¼€å§‹" },
    { id: 2, title: "æ˜¥èŠ‚", date: "2026-02-17", theme: "from-red-500 to-orange-500", icon: "ğŸ§§", desc: "é˜–å®¶å›¢åœ†çš„æ—¥å­" },
    { id: 3, title: "æƒ…äººèŠ‚", date: "2026-02-14", theme: "from-pink-400 to-rose-500", icon: "ğŸŒ¹", desc: "çˆ±ä¸è¢«çˆ±çš„æ—¶åˆ»" },
    { id: 4, title: "åœ£è¯èŠ‚", date: "2025-12-25", theme: "from-green-400 to-emerald-600", icon: "ğŸ„", desc: "é›ªèŠ±ä¸ç¤¼ç‰©çš„å­£èŠ‚" },
  ];

  const [events, setEvents] = useState(initialEvents);
  const [selectedEventId, setSelectedEventId] = useState(1);
  const [timeLeft, setTimeLeft] = useState(calculateTimeLeft(events[0].date));
  const [showAddModal, setShowAddModal] = useState(false);
  
  // æ–°å»ºäº‹ä»¶çš„çŠ¶æ€
  const [newEvent, setNewEvent] = useState({ title: '', date: '', desc: '' });

  // è·å–å½“å‰é€‰ä¸­çš„äº‹ä»¶å¯¹è±¡
  const currentEvent = events.find(e => e.id === selectedEventId) || events[0];

  useEffect(() => {
    const timer = setInterval(() => {
      setTimeLeft(calculateTimeLeft(currentEvent.date));
    }, 1000);
    return () => clearInterval(timer);
  }, [currentEvent]);

  // å¤„ç†æ·»åŠ äº‹ä»¶
  const handleAddEvent = () => {
    if (!newEvent.title || !newEvent.date) return;
    const id = events.length + 1;
    // éšæœºåˆ†é…ä¸€ä¸ªå¥½çœ‹çš„æ¸å˜è‰²
    const themes = [
      "from-indigo-400 to-cyan-400",
      "from-fuchsia-500 to-purple-600",
      "from-amber-400 to-orange-500",
      "from-teal-400 to-emerald-500"
    ];
    const randomTheme = themes[Math.floor(Math.random() * themes.length)];
    
    const eventToAdd = {
      id,
      title: newEvent.title,
      date: newEvent.date,
      theme: randomTheme,
      icon: "âœ¨",
      desc: newEvent.desc || "ç‰¹åˆ«çš„ä¸€å¤©"
    };

    setEvents([...events, eventToAdd]);
    setShowAddModal(false);
    setNewEvent({ title: '', date: '', desc: '' });
    setSelectedEventId(id); // è‡ªåŠ¨è·³è½¬åˆ°æ–°äº‹ä»¶
  };

  // åˆ é™¤äº‹ä»¶
  const handleDelete = (e, id) => {
    e.stopPropagation();
    const newEvents = events.filter(ev => ev.id !== id);
    setEvents(newEvents);
    if (selectedEventId === id && newEvents.length > 0) {
      setSelectedEventId(newEvents[0].id);
    }
  };

  return (
    <div className={`relative min-h-screen overflow-hidden bg-gray-900 text-white font-sans transition-colors duration-1000 ease-in-out`}>
      
      {/* åŠ¨æ€èƒŒæ™¯å±‚ */}
      <div className={`absolute inset-0 bg-gradient-to-br ${currentEvent.theme} opacity-20 blur-3xl transform scale-150 animate-pulse duration-[5000ms]`}></div>
      <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10"></div>
      
      {/* ç²’å­ç”»å¸ƒ */}
      <ParticleCanvas activeColor="#ffffff" />

      {/* ä¸»ç•Œé¢å®¹å™¨ */}
      <div className="relative z-10 container mx-auto px-4 py-8 flex flex-col h-screen max-w-md md:max-w-2xl lg:max-w-4xl mx-auto">
        
        {/* é¡¶éƒ¨å¯¼èˆª */}
        <header className="flex justify-between items-center mb-8">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-md border border-white/20">
              <Clock size={16} />
            </div>
            <span className="font-bold text-xl tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white to-white/70">
              FLUX MOMENTS
            </span>
          </div>
          <button 
            onClick={() => setShowAddModal(true)}
            className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center backdrop-blur-md border border-white/20 transition-all hover:scale-105 active:scale-95 shadow-lg shadow-black/10"
          >
            <Plus size={20} />
          </button>
        </header>

        {/* æ ¸å¿ƒå€’è®¡æ—¶åŒºåŸŸ (Interactive Zone) */}
        <main className="flex-grow flex flex-col items-center justify-center interactive-zone cursor-pointer group">
          <div className="text-center mb-10 transform transition-transform duration-500 hover:scale-105">
            <div className="inline-block px-4 py-1 rounded-full bg-white/5 border border-white/10 backdrop-blur-sm text-sm font-medium mb-4 text-white/80 animate-bounce">
              {currentEvent.desc}
            </div>
            <h1 className="text-5xl md:text-7xl font-bold mb-2 drop-shadow-2xl">
              {currentEvent.title} <span className="text-4xl align-top">{currentEvent.icon}</span>
            </h1>
            <p className="text-white/50 text-sm tracking-widest uppercase mt-2">
              {currentEvent.date}
            </p>
          </div>

          {/* æ‹Ÿæ€å€’è®¡æ—¶å¡ç‰‡ */}
          <div className="grid grid-cols-4 gap-3 md:gap-6 w-full max-w-lg">
            {['days', 'hours', 'minutes', 'seconds'].map((unit, idx) => (
              <div key={unit} className="relative group/card">
                <div className="absolute inset-0 bg-gradient-to-br from-white/20 to-white/5 rounded-2xl blur-sm transform group-hover/card:scale-110 transition-transform duration-500"></div>
                <div className="relative bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-4 md:p-6 flex flex-col items-center justify-center shadow-xl shadow-black/20 aspect-[4/5] overflow-hidden">
                  {/* æµåŠ¨å…‰æ•ˆ */}
                  <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/10 to-transparent opacity-0 group-hover/card:opacity-100 transition-opacity duration-500"></div>
                  
                  <span className="text-3xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-b from-white to-white/60 tabular-nums">
                    {timeLeft[unit].toString().padStart(2, '0')}
                  </span>
                  <span className="text-[10px] md:text-xs uppercase tracking-widest text-white/50 mt-2 font-medium">
                    {unit === 'days' ? 'å¤©' : unit === 'hours' ? 'æ—¶' : unit === 'minutes' ? 'åˆ†' : 'ç§’'}
                  </span>
                </div>
              </div>
            ))}
          </div>

          <p className="mt-8 text-white/40 text-sm italic">
            "ç‚¹å‡»å±å¹•ï¼Œæ•æ‰æ­¤åˆ»çš„æ—¶å…‰ç¢ç‰‡"
          </p>
        </main>

        {/* åº•éƒ¨èŠ‚æ—¥åˆ—è¡¨ (Scrollable) */}
        <div className="mt-auto pt-8">
          <h3 className="text-sm font-medium text-white/50 mb-4 px-1 flex items-center gap-2">
            <Calendar size={14} /> å³å°†åˆ°æ¥çš„æ—¶åˆ»
          </h3>
          <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide snap-x">
            {events.map((ev) => (
              <div 
                key={ev.id}
                onClick={() => setSelectedEventId(ev.id)}
                className={`
                  snap-center shrink-0 w-48 md:w-56 p-4 rounded-xl cursor-pointer transition-all duration-300 border
                  flex flex-col justify-between h-32 relative overflow-hidden
                  ${selectedEventId === ev.id 
                    ? 'bg-white/15 border-white/40 shadow-lg shadow-purple-500/20 scale-100' 
                    : 'bg-white/5 border-white/5 hover:bg-white/10 hover:border-white/20 scale-95 opacity-70 hover:opacity-100'}
                `}
              >
                {/* èƒŒæ™¯æ¸å˜ç‚¹ç¼€ */}
                <div className={`absolute -right-4 -top-4 w-16 h-16 bg-gradient-to-br ${ev.theme} rounded-full blur-xl opacity-40`}></div>
                
                <div className="flex justify-between items-start z-10">
                  <span className="text-2xl">{ev.icon}</span>
                  {ev.id > 4 && (
                     <button onClick={(e) => handleDelete(e, ev.id)} className="text-white/20 hover:text-red-400 transition-colors">
                       <Trash2 size={14} />
                     </button>
                  )}
                </div>
                
                <div className="z-10">
                  <h4 className="font-bold text-lg leading-tight truncate">{ev.title}</h4>
                  <p className="text-xs text-white/50 mt-1">{ev.date}</p>
                </div>
                
                {selectedEventId === ev.id && (
                  <div className="absolute bottom-2 right-2 animate-pulse">
                    <Sparkles size={16} className="text-white/40" />
                  </div>
                )}
              </div>
            ))}
            
            {/* æ·»åŠ æŒ‰é’®å¡ç‰‡ */}
            <div 
              onClick={() => setShowAddModal(true)}
              className="snap-center shrink-0 w-16 md:w-20 rounded-xl border border-white/5 border-dashed flex items-center justify-center bg-white/5 hover:bg-white/10 cursor-pointer transition-colors scale-95 h-32"
            >
              <Plus size={24} className="text-white/30" />
            </div>
          </div>
        </div>

      </div>

      {/* æ·»åŠ äº‹ä»¶æ¨¡æ€æ¡† */}
      {showAddModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-md" onClick={() => setShowAddModal(false)}></div>
          <div className="bg-gray-900 border border-white/10 w-full max-w-sm rounded-2xl p-6 relative z-10 shadow-2xl animate-fade-in-up">
            <button 
              onClick={() => setShowAddModal(false)}
              className="absolute top-4 right-4 text-white/30 hover:text-white"
            >
              <X size={20} />
            </button>
            
            <h2 className="text-2xl font-bold mb-1 flex items-center gap-2">
              <Heart className="text-pink-500 fill-pink-500" size={20} />
              æ–°æ—¶åˆ»
            </h2>
            <p className="text-white/40 text-sm mb-6">è®°å½•ä¸€ä¸ªå€¼å¾—æœŸå¾…çš„æ—¥å­ã€‚</p>
            
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-medium text-white/50 mb-1 uppercase tracking-wider">æ ‡é¢˜</label>
                <input 
                  type="text" 
                  value={newEvent.title}
                  onChange={(e) => setNewEvent({...newEvent, title: e.target.value})}
                  placeholder="ä¾‹å¦‚ï¼šå¦ˆå¦ˆç”Ÿæ—¥"
                  className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/20 focus:outline-none focus:border-purple-500 transition-colors"
                />
              </div>
              
              <div>
                <label className="block text-xs font-medium text-white/50 mb-1 uppercase tracking-wider">æ—¥æœŸ</label>
                <input 
                  type="date" 
                  value={newEvent.date}
                  onChange={(e) => setNewEvent({...newEvent, date: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors [color-scheme:dark]"
                />
              </div>

              <div>
                <label className="block text-xs font-medium text-white/50 mb-1 uppercase tracking-wider">å¯„è¯­ (é€‰å¡«)</label>
                <input 
                  type="text" 
                  value={newEvent.desc}
                  onChange={(e) => setNewEvent({...newEvent, desc: e.target.value})}
                  placeholder="ä¾‹å¦‚ï¼šç¾å¥½çš„äº‹æƒ…å³å°†å‘ç”Ÿ"
                  className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-white/20 focus:outline-none focus:border-purple-500 transition-colors"
                />
              </div>

              <button 
                onClick={handleAddEvent}
                className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-400 hover:to-purple-500 text-white font-bold py-3 rounded-lg mt-2 shadow-lg shadow-purple-900/50 transition-all active:scale-95 flex items-center justify-center gap-2"
              >
                å¼€å§‹å€’è®¡æ—¶ <ChevronRight size={18} />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ä¿®å¤ï¼šç§»é™¤ jsx å’Œ global å±æ€§ï¼Œä½¿ç”¨æ ‡å‡†çš„ style æ ‡ç­¾ */}
      <style>{`
        @keyframes fade-in-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
          animation: fade-in-up 0.3s ease-out forwards;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
      `}</style>
    </div>
  );
}
